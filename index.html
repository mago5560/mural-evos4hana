<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js Im치genes Interactivas - Mejorado</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js para A-Frame -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }
   
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10;
    }
   
    .hint {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      padding: 12px 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border-radius: 25px;
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      max-width: 80%;
      text-align: center;
      pointer-events: auto;
      animation: fadeIn 0.5s ease-out;
    }
   
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: auto;
    }
   
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.9);
      color: #333;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
   
    .control-btn:hover {
      background: #fff;
      transform: scale(1.1);
    }
   
    .loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 16px;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border-radius: 10px;
      pointer-events: auto;
    }
   
    #patternMarker {
      display: none;
    }
   
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
   
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
   
    .pulsing {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div class="ui-overlay">
    <div class="hint" id="hint">
      Apunta al marcador y toca una imagen para centrarla
    </div>
   
    <div class="controls">
      <button class="control-btn" id="resetBtn" title="Reiniciar vista">游댃</button>
      <button class="control-btn" id="zoomBtn" title="Alternar zoom">游댌</button>
    </div>
   
    <div class="loading-indicator" id="loading" style="display: none;">
      Cargando AR...
    </div>
  </div>
 
  <img id="patternMarker" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/sdinicio.png" alt="Pattern Marker">
 
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true; precision: medium; alpha: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    loading-screen="enabled: false"
  >
    <!-- Assets con im치genes -->
    <a-assets>
      <img id="img1" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/Apli_SD.png" crossorigin="anonymous">
      <img id="img2" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/CO.png" crossorigin="anonymous">
      <img id="img3" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/EWM.png" crossorigin="anonymous">
      <img id="img4" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/FI.png" crossorigin="anonymous">
      <img id="img5" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/HCM.png" crossorigin="anonymous">
      <img id="img6" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/MM.png" crossorigin="anonymous">
      <img id="img7" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/PM.png" crossorigin="anonymous">
      <img id="img8" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/PP.png" crossorigin="anonymous">
      <img id="img9" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/QM.png" crossorigin="anonymous">
      <img id="img10" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/SD.png" crossorigin="anonymous">

      <a-asset-item id="eva" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/EvaBot.glb"></a-asset-item>
      <a-asset-item id="walle" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/WalleBot.glb"></a-asset-item>
    </a-assets>
 
    <!-- Luces mejoradas -->
    <a-entity light="type: ambient; intensity: 0.6; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.8; color: #ffffff" position="2 4 2"></a-entity>
    <a-entity light="type: point; intensity: 0.3; color: #ffffff" position="0 2 0"></a-entity>
 
    <!-- Marcador -->
    <a-marker
      type="pattern"
      url="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/pattern-sdinicio.patt"
      raycaster="objects: .clickable; far: 50; near: 0"
      emitevents="true"
      cursor="rayOrigin: mouse; fuse: false"
      id="marker"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
     
      <!-- Contenedor de las im치genes -->
      <a-entity id="image-group" position="0 0 0" rotation="0 0 0"></a-entity>
     
      <!-- Indicador del centro -->
      <a-ring
        id="center-indicator"
        position="0 0.05 0"
        rotation="-90 0 0"
        radius-inner="1.8"
        radius-outer="2"
        color="#03A9F4"
        opacity="0.3"
        visible="true">
      </a-ring>
    </a-marker>
 
          <!-- Modelo de Eva con movimiento autom치tico -->
                <a-entity id="eva" position="0 0.5 0" rotation="0 0 0" scale="1.2 1.2 1.2" 
                          gltf-model="#eva-model" animation-mixer="clip: *; loop: repeat">
                </a-entity>
                
    <!-- C치mara y cursor -->
    <a-entity camera look-controls wasd-controls="enabled: true">
      <a-cursor
        rayOrigin="mouse"
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
        material="color: #03A9F4; shader: flat"
        position="0 0 -1"
        visible="true">
      </a-cursor>
    </a-entity>
  </a-scene>
 
  <script>
    let currentZoomLevel = 1;
    let isAnimating = false;
    const originalPositions = {};
   
    // Configuraci칩n mejorada
    const CONFIG = {
      RING_RADIUS: 3.2,        // Radio del anillo (aumentado)
      Y_POSITION: 0.08,        // Altura de las im치genes
      CENTER_SCALE: {x: 2.8, y: 1.4, z: 1},    // Escala central (reducida)
      RING_SCALE: {x: 1.4, y: 0.7, z: 1},      // Escala del anillo (reducida)
      ANIMATION_DURATION: 400,  // Duraci칩n de animaciones
      HOVER_SCALE: 1.1,        // Escala al hover
      MIN_SEPARATION: 0.8      // Separaci칩n m칤nima entre im치genes
    };
 
    // Crear un plano con imagen mejorado
    function createImagePlane(id, src, position, scale = CONFIG.RING_SCALE, isCenter = false) {
      const e = document.createElement('a-plane');
      e.setAttribute('id', id);
      e.classList.add('imgplane', 'clickable');
      e.setAttribute('material', `src: ${src}; side: double; transparent: true; alphaTest: 0.1`);
      e.setAttribute('geometry', `width: ${scale.x}; height: ${scale.y}`);
      e.setAttribute('position', position);
      e.setAttribute('rotation', '-90 0 0');
     
      // Agregar efectos visuales
      if (!isCenter) {
        e.setAttribute('animation__hover', {
          property: 'scale',
          to: `${CONFIG.HOVER_SCALE} ${CONFIG.HOVER_SCALE} 1`,
          startEvents: 'mouseenter',
          dur: 200,
          easing: 'easeOutQuad'
        });
       
        e.setAttribute('animation__unhover', {
          property: 'scale',
          to: '1 1 1',
          startEvents: 'mouseleave',
          dur: 200,
          easing: 'easeOutQuad'
        });
      }
     
      return e;
    }
 
    // Calcular posiciones sin superposici칩n
    function calculateOptimalPositions(count) {
      const positions = [];
      const angleStep = (Math.PI * 2) / (count - 1);
     
      for (let i = 0; i < count - 1; i++) {
        const angle = i * angleStep;
        const x = CONFIG.RING_RADIUS * Math.cos(angle);
        const z = CONFIG.RING_RADIUS * Math.sin(angle);
        positions.push({x, y: CONFIG.Y_POSITION, z});
      }
     
      return positions;
    }
 
    const group = document.getElementById('image-group');
    const centerIndicator = document.getElementById('center-indicator');
 
    const images = [
      '#img1', '#img1','#img2','#img3','#img4','#img5',
      '#img6','#img7','#img8','#img9','#img10'
    ];
 
    // Imagen central inicial
    const center = createImagePlane(
      'img-center',
      images[0],
      `0 ${CONFIG.Y_POSITION} 0`,
      CONFIG.CENTER_SCALE,
      true
    );
    center.dataset.isCenter = 'true';
    center.dataset.originalIndex = '0';
    group.appendChild(center);
 
    // Calcular posiciones 칩ptimas para evitar superposici칩n
    const ringPositions = calculateOptimalPositions(images.length);
 
    // Colocar las dem치s en c칤rculo con posiciones optimizadas
    for (let i = 1; i < images.length; i++) {
      const pos = ringPositions[i - 1];
      const id = `img-${i}`;
      const posStr = `${pos.x.toFixed(3)} ${pos.y} ${pos.z.toFixed(3)}`;
     
      const plane = createImagePlane(id, images[i], posStr, CONFIG.RING_SCALE);
      plane.dataset.originalPosition = posStr;
      plane.dataset.originalIndex = i.toString();
      originalPositions[i] = pos;
     
      group.appendChild(plane);
    }
 
    // Animaciones mejoradas
    function animateTo(entity, toPos, toScale, dur = CONFIG.ANIMATION_DURATION) {
      if (isAnimating) return;
     
      entity.setAttribute('animation__pos', {
        property: 'position',
        to: toPos,
        dur,
        easing: 'easeInOutCubic'
      });
     
      entity.setAttribute('animation__scale', {
        property: 'geometry',
        to: `width: ${toScale.x}; height: ${toScale.y}`,
        dur,
        easing: 'easeInOutCubic'
      });
    }
 
    function swapToCenter(target) {
      if (isAnimating) return;
     
      const currentCenter = group.querySelector('[data-is-center="true"]');
      if (!currentCenter || target === currentCenter) return;
 
      isAnimating = true;
     
      const targetOriginalPos = target.dataset.originalPosition;
      const targetIndex = target.dataset.originalIndex;
      const centerIndex = currentCenter.dataset.originalIndex;
 
      // Animaci칩n hacia el centro
      animateTo(target, `0 ${CONFIG.Y_POSITION} 0`, CONFIG.CENTER_SCALE);
      target.dataset.isCenter = 'true';
     
      // Mostrar indicador del centro brevemente
      centerIndicator.setAttribute('visible', true);
      setTimeout(() => {
        centerIndicator.setAttribute('visible', false);
      }, 1000);
 
      // Animaci칩n desde el centro hacia el anillo
      animateTo(currentCenter, targetOriginalPos, CONFIG.RING_SCALE);
      delete currentCenter.dataset.isCenter;
      currentCenter.dataset.originalPosition = targetOriginalPos;
 
      // Intercambiar 칤ndices
      target.dataset.originalIndex = centerIndex;
      currentCenter.dataset.originalIndex = targetIndex;
 
      // Actualizar hint
      updateHint(`Imagen ${parseInt(targetIndex) + 1} seleccionada`);
     
      setTimeout(() => {
        isAnimating = false;
      }, CONFIG.ANIMATION_DURATION);
    }
 
    function updateHint(message) {
      const hint = document.getElementById('hint');
      hint.textContent = message;
      hint.classList.remove('pulsing');
      setTimeout(() => {
        hint.classList.add('pulsing');
      }, 100);
     
      setTimeout(() => {
        hint.textContent = 'Toca una imagen para centrarla';
        hint.classList.remove('pulsing');
      }, 2000);
    }
 
    function resetView() {
      if (isAnimating) return;
     
      isAnimating = true;
      const currentCenter = group.querySelector('[data-is-center="true"]');
     
      if (currentCenter && currentCenter.dataset.originalIndex !== '0') {
        // Encontrar la imagen original del centro
        const originalCenter = group.querySelector(`[data-original-index="0"]`);
        if (originalCenter && originalCenter !== currentCenter) {
          swapToCenter(originalCenter);
        }
      }
     
      updateHint('Vista reiniciada');
      setTimeout(() => { isAnimating = false; }, CONFIG.ANIMATION_DURATION);
    }
 
    function toggleZoom() {
      currentZoomLevel = currentZoomLevel === 1 ? 1.3 : 1;
      const scaleStr = `${currentZoomLevel} ${currentZoomLevel} ${currentZoomLevel}`;
     
      group.setAttribute('animation', {
        property: 'scale',
        to: scaleStr,
        dur: 300,
        easing: 'easeInOutQuad'
      });
     
      updateHint(currentZoomLevel > 1 ? 'Vista ampliada' : 'Vista normal');
    }
 
    // Event listeners
    group.addEventListener('click', (ev) => {
      const t = ev.target;
      if (!t.classList || !t.classList.contains('imgplane')) return;
      if (t.dataset.isCenter === 'true') return;
     
      swapToCenter(t);
    });
 
    // Controles UI
    document.getElementById('resetBtn').addEventListener('click', resetView);
    document.getElementById('zoomBtn').addEventListener('click', toggleZoom);
 
    // Prevenir scroll en m칩viles
    document.body.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });
 
    // Mejorar la detecci칩n de toque en m칩viles
    let touchStartTime = 0;
    group.addEventListener('touchstart', () => {
      touchStartTime = Date.now();
    });
   
    group.addEventListener('touchend', (ev) => {
      const touchDuration = Date.now() - touchStartTime;
      if (touchDuration < 500) { // Toque r치pido
        const t = ev.target;
        if (t.classList && t.classList.contains('imgplane') && t.dataset.isCenter !== 'true') {
          swapToCenter(t);
        }
      }
    });
 
    // Inicializaci칩n
    setTimeout(() => {
      updateHint('춰AR listo! Apunta al marcador');
    }, 1000);
 
    // Debugging - mostrar cuando se detecta el marcador
    const marker = document.getElementById('marker');
    marker.addEventListener('markerFound', () => {
      updateHint('춰Marcador detectado!');
    });
   
    marker.addEventListener('markerLost', () => {
      updateHint('Marcador perdido - reenfoca');
    });




    //Movimiento EVA y Walle
          // Variables globales
        let currentBehavior = 'patrol';
        let currentSpeed = 1;
        let movementInterval;
        let cameraMode = 'follow';

// Obtener referencia a Eva
            const eva = document.querySelector('#eva');
   // Iniciar movimiento autom치tico
        function startAutomaticMovement() {
            const eva = document.querySelector('#eva');
            
            // Limpiar cualquier intervalo existente
            if (movementInterval) clearInterval(movementInterval);
            
            // Configurar el intervalo seg칰n el comportamiento actual
            switch(currentBehavior) {
                case 'patrol':
                    patrolMovement(eva);
                    break;
                case 'hover':
                    hoverMovement(eva);
                    break;
                case 'circle':
                    circleMovement(eva);
                    break;
                case 'random':
                    randomMovement(eva);
                    break;
            }
        }
        
        // Comportamiento: Patrullar
        function patrolMovement(eva) {
            const points = [
                {x: -3, y: 0.5, z: -3},
                {x: 3, y: 0.5, z: -3},
                {x: 3, y: 0.5, z: 3},
                {x: -3, y: 0.5, z: 3}
            ];
            let currentPoint = 0;
            
            movementInterval = setInterval(() => {
                const nextPoint = points[currentPoint % points.length];
                eva.setAttribute('animation', {
                    property: 'position',
                    to: `${nextPoint.x} ${nextPoint.y} ${nextPoint.z}`,
                    dur: 3000 / currentSpeed,
                    easing: 'easeInOutQuad'
                });
                
                // Rotar hacia el siguiente punto
                const currentPos = eva.getAttribute('position');
                const angle = Math.atan2(nextPoint.x - currentPos.x, nextPoint.z - currentPos.z) * 180 / Math.PI;
                eva.setAttribute('animation__rotation', {
                    property: 'rotation',
                    to: `0 ${angle} 0`,
                    dur: 1000 / currentSpeed,
                    easing: 'easeInOutQuad'
                });
                
                currentPoint++;
            }, 3000 / currentSpeed);
        }
        
        // Comportamiento: Flotar
        function hoverMovement(eva) {
            let goingUp = true;
            
            movementInterval = setInterval(() => {
                const currentPos = eva.getAttribute('position');
                const newY = goingUp ? 2 : 0.5;
                
                eva.setAttribute('animation', {
                    property: 'position',
                    to: `${currentPos.x} ${newY} ${currentPos.z}`,
                    dur: 2000 / currentSpeed,
                    easing: 'easeInOutQuad'
                });
                
                goingUp = !goingUp;
            }, 2000 / currentSpeed);
        }
        
        // Comportamiento: Circular
        function circleMovement(eva) {
            let angle = 0;
            const radius = 3;
            const center = {x: 0, y: 0.5, z: 0};
            
            movementInterval = setInterval(() => {
                angle += 0.1 * currentSpeed;
                const x = center.x + radius * Math.cos(angle);
                const z = center.z + radius * Math.sin(angle);
                
                eva.setAttribute('position', {
                    x: x,
                    y: center.y,
                    z: z
                });
                
                // Rotar en la direcci칩n del movimiento
                eva.setAttribute('rotation', {
                    x: 0,
                    y: -angle * 180 / Math.PI + 90,
                    z: 0
                });
            }, 50);
        }
        
        // Comportamiento: Aleatorio
        function randomMovement(eva) {
            movementInterval = setInterval(() => {
                const x = -4 + Math.random() * 8;
                const z = -4 + Math.random() * 8;
                
                eva.setAttribute('animation', {
                    property: 'position',
                    to: `${x} 0.5 ${z}`,
                    dur: 2000 / currentSpeed,
                    easing: 'easeInOutQuad'
                });
                
                // Rotar hacia la nueva posici칩n
                const currentPos = eva.getAttribute('position');
                const angle = Math.atan2(x - currentPos.x, z - currentPos.z) * 180 / Math.PI;
                eva.setAttribute('animation__rotation', {
                    property: 'rotation',
                    to: `0 ${angle} 0`,
                    dur: 1000 / currentSpeed,
                    easing: 'easeInOutQuad'
                });
            }, 2000 / currentSpeed);
        }
        
        // Cambiar comportamiento
        function changeBehavior(behavior) {
            currentBehavior = behavior;
            document.getElementById('behavior-status').textContent = `Comportamiento: ${getBehaviorName(behavior)}`;
            startAutomaticMovement();
        }
        
        // Cambiar velocidad
        function changeSpeed(speed) {
            switch(speed) {
                case 'slow':
                    currentSpeed = 0.5;
                    break;
                case 'normal':
                    currentSpeed = 1;
                    break;
                case 'fast':
                    currentSpeed = 2;
                    break;
            }
            document.getElementById('speed-status').textContent = `Velocidad: ${getSpeedName(speed)}`;
            startAutomaticMovement();
        }
        
        // Cambiar vista de c치mara
        function changeCameraView(view) {
            cameraMode = view;
            const cameraRig = document.querySelector('#camera-rig');
            
            switch(view) {
                case 'follow':
                    // La c치mara se actualiza en el intervalo principal
                    break;
                case 'overview':
                    cameraRig.setAttribute('animation', {
                        property: 'position',
                        to: '0 8 0',
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                    break;
                case 'firstPerson':
                    const evaPosition = document.querySelector('#eva').getAttribute('position');
                    cameraRig.setAttribute('animation', {
                        property: 'position',
                        to: `${evaPosition.x} ${evaPosition.y + 0.5} ${evaPosition.z + 1}`,
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                    break;
            }
        }

  </script>
</body>
</html>