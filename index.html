<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
 
  <title>Mural SD</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js para A-Frame -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    .hint { 
      position: fixed; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      padding: 10px 12px; 
      font-family: system-ui, sans-serif; 
      background: rgba(0,0,0,.55); 
      color: #fff; 
      text-align: center; 
      z-index: 10; 
    }
    #patternMarker {
      display: none;
    }
    #markerStatus {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      font-family: system-ui, sans-serif;
      background: rgba(255,165,0,0.8);
      color: white;
      border-radius: 5px;
      z-index: 10;
      font-size: 12px;
    }
    #markerStatus.active {
      background: rgba(0,128,0,0.8);
    }
  </style>
</head>
<body>
  <div class="hint">Apunta a tu imagen personalizada. Una vez detectado, los objetos permanecerán visibles.</div>
  <div id="markerStatus">Buscando marcador...</div>

  <img id="patternMarker" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/sdinicio.png" alt="Pattern Marker">

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true; precision: medium;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;
          detectionMode: mono_and_matrix; matrixCodeType: 3x3;
          smoothing: true; smoothingCount: 5; smoothingTolerance: 0.01; smoothingThreshold: 2"
  >

  <a-assets>
    <a-asset-item id="patternMarkerSrc" src="#patternMarker"></a-asset-item>
    <img id="img-sd" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/SD.png" crossorigin="anonymous">
    <img id="img-pm" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/PM.png" crossorigin="anonymous">
    <img id="img-co" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/CO.png" crossorigin="anonymous">
    <img id="img-fi" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/FI.png" crossorigin="anonymous">
    <img id="img-ewm" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/EWM.png" crossorigin="anonymous">
    <img id="img-pp" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/PP.png" crossorigin="anonymous">
    <img id="img-hcm" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/HCM.png" crossorigin="anonymous">
    <img id="img-mm" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/MM.png" crossorigin="anonymous">
    <img id="img-qm" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/QM.png" crossorigin="anonymous">
    <img id="img-Aplicativos SD" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/Apli_SD.png" crossorigin="anonymous">
    <a-asset-item id="img-wally" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/WalleBot.glb"></a-asset-item>
    <a-asset-item id="img-eva" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/EvaBot.glb"></a-asset-item>
    <img id="img-evolution" src="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/asset/evos4h.png" crossorigin="anonymous">
  </a-assets>

  <!-- Luz -->
  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="1 1 0"></a-entity>

  <!-- Marcador SOLO para detección -->
  <a-marker 
    type="pattern" 
    url="https://raw.githubusercontent.com/mago5560/mural-evos4hana/main/pattern-sdinicio.patt"
    id="marker">
    <!-- Contenido vacío - solo detección -->
  </a-marker>

  <!-- Contenido PERMANENTE fuera del marcador -->
  <a-entity id="permanent-content" visible="false">
    <!-- Eva y Wally -->
    <a-gltf-model 
      id="eva-permanent"
      src="#img-eva" 
      position="-4.7 0.1 0" 
      scale="0.5 0.5 0.5" 
      rotation="0 90 0">
    </a-gltf-model>
    
    <a-gltf-model 
      id="wally-permanent"
      src="#img-wally" 
      position="4.7 0.1 0" 
      scale="0.5 0.5 0.5" 
      rotation="0 90 0">
    </a-gltf-model>
  </a-entity>

  <a-entity camera look-controls>
    <a-cursor rayOrigin="mouse"></a-cursor>
  </a-entity>
  </a-scene>
 
  <script>
    let isActivated = false;
    const marker = document.getElementById('marker');
    const permanentContent = document.getElementById('permanent-content');
    const statusElement = document.getElementById('markerStatus');

    // Escuchar detección del marcador
    marker.addEventListener('markerFound', function() {
      if (!isActivated) {
        console.log('Marcador detectado - Activando contenido permanente');
        
        // Obtener posición y rotación del marcador
        const markerPos = marker.object3D.position.clone();
        const markerRot = marker.object3D.rotation.clone();
        const markerScale = marker.object3D.scale.clone();
        
        // Aplicar transformaciones al contenido permanente
        permanentContent.object3D.position.copy(markerPos);
        permanentContent.object3D.rotation.copy(markerRot);
        permanentContent.object3D.scale.copy(markerScale);
        
        // Hacer visible el contenido permanente
        permanentContent.setAttribute('visible', true);
        
        // Actualizar estado
        isActivated = true;
        statusElement.textContent = '¡Contenido activo permanentemente!';
        statusElement.classList.add('active');
        
        // Vibración
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
        
        // Crear los octágonos después de activar
        createOctagons();
        
        // Inicializar animaciones
        setTimeout(initializeAnimations, 200);
      }
    });

    // Crear octágonos
    function createOctagons() {
      function createImage(id, position, src, scale = {x: 1, y: 1, z: 1}) {
        const img = document.createElement('a-image');
        img.setAttribute('id', id);
        img.classList.add('octagon');
        img.classList.add('clickable');
        img.setAttribute('src', src);
        img.setAttribute('position', position);
        img.setAttribute('rotation', '-90 0 0');
        img.setAttribute('scale', `${scale.x} ${scale.y} ${scale.z}`);
        img.setAttribute('width', 1.9);
        img.setAttribute('height', 1.2);
        return img;
      }

      // Octágono central
      const center = createImage('octagon-center', '0 0.12 0', '#img-evolution', {x:2.2, y:2.2, z:2.2});
      center.dataset.isCenter = 'true';
      permanentContent.appendChild(center);

      // Octágonos del anillo
      const imgSources = [
        '#img-sd', '#img-pm', '#img-co', '#img-fi', '#img-ewm',
        '#img-pp', '#img-hcm', '#img-mm', '#img-qm', '#img-Aplicativos SD'
      ];

      const R = 3.5;
      const Y = 0.1;
      const count = 10;

      for (let i = 0; i < count; i++) {
        const theta = (i / count) * Math.PI * 2;
        const x = R * Math.cos(theta);
        const z = R * Math.sin(theta);
        const id = `image-${i+1}`;
        const img = createImage(id, `${x.toFixed(3)} ${Y} ${z.toFixed(3)}`, imgSources[i], {x: 1, y: 1, z: 1});
        permanentContent.appendChild(img);
      }

      // Configurar interacciones
      setupInteractions();
    }

    // Configurar interacciones de octágonos
    function setupInteractions() {
      function animateTo(entity, toPos, toScale, dur = 350) {
        entity.setAttribute('animation__pos', {
          property: 'position', to: toPos, dur, easing: 'easeInOutQuad'
        });
        entity.setAttribute('animation__scale', {
          property: 'scale', to: toScale, dur, easing: 'easeInOutQuad'
        });
      }

      function swapToCenter(target) {
        const currentCenter = permanentContent.querySelector('[data-is-center="true"]');
        if (!currentCenter || target === currentCenter) return;

        const targetOriginalPos = target.getAttribute('position');
        const targetOriginalSlot = target.dataset.originalPosition || `${targetOriginalPos.x} ${targetOriginalPos.y} ${targetOriginalPos.z}`;
        const centerScaleSmall = '1 1 1';
        const bigScale = '2.2 2.2 2.2';

        animateTo(target, '0 0.1 0', bigScale);
        target.dataset.isCenter = 'true';

        animateTo(currentCenter, targetOriginalSlot, centerScaleSmall);
        delete currentCenter.dataset.isCenter;

        currentCenter.dataset.originalPosition = targetOriginalSlot;
      }

      permanentContent.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t.classList || !t.classList.contains('octagon')) return;
        if (t.dataset.isCenter === 'true') return;
        swapToCenter(t);
      });
    }

    // Inicializar animaciones de Eva y Wally
    function initializeAnimations() {
      const eva = document.getElementById('eva-permanent');
      const wally = document.getElementById('wally-permanent');
      
      if (!eva || !wally) {
        console.warn('Eva o Wally no encontrados');
        return;
      }

      const centerPosition = { x: 0, y: 0.1, z: 0 };
      const innerRadius = 1.8;
      const outerRadius = 4.0;
      const speed = 0.01;

      let angleEva = 0;
      let angleWally = Math.PI;
      let evaAfuera = false;
      let wallyAfuera = false;

      function updatePositions() {
        if (!evaAfuera) {
          const evaX = centerPosition.x + innerRadius * Math.cos(angleEva);
          const evaZ = centerPosition.z + innerRadius * Math.sin(angleEva);
          eva.setAttribute('position', `${evaX} ${centerPosition.y} ${evaZ}`);
          angleEva += speed;
        } else {
          const evaX = centerPosition.x + outerRadius * Math.cos(angleEva);
          const evaZ = centerPosition.z + outerRadius * Math.sin(angleEva);
          eva.setAttribute('position', `${evaX} ${centerPosition.y} ${evaZ}`);
          angleEva += 0.03;
        }

        if (!wallyAfuera) {
          const wallyX = centerPosition.x + innerRadius * Math.cos(angleWally);
          const wallyZ = centerPosition.z + innerRadius * Math.sin(angleWally);
          wally.setAttribute('position', `${wallyX} ${centerPosition.y} ${wallyZ}`);
          angleWally += speed;
        } else {
          const wallyX = centerPosition.x + outerRadius * Math.cos(angleWally);
          const wallyZ = centerPosition.z + outerRadius * Math.sin(angleWally);
          wally.setAttribute('position', `${wallyX} ${centerPosition.y} ${wallyZ}`);
          angleWally += 0.03;
        }

        requestAnimationFrame(updatePositions);
      }

      eva.addEventListener('click', () => { evaAfuera = !evaAfuera; });
      wally.addEventListener('click', () => { wallyAfuera = !wallyAfuera; });

      updatePositions();
    }

    // Prevenir drag en móviles
    document.body.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
  </script>
</body>
</html>